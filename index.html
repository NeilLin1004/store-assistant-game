<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†åº—å°å¹«æ‰‹ - ç‹¸å…‹å•†åº—ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* å¼•å…¥åœ“æ½¤å¯æ„›çš„å­—é«” */
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap');
        
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            color: #5d4037;
            background-color: #b8e9e4;
            background-image: radial-gradient(#ffffff 20%, transparent 20%),
                              radial-gradient(#ffffff 20%, transparent 20%);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
            touch-action: manipulation;
        }

        /* è‡ªå®šç¾©å¯æ„›é¡è‰² */
        .bg-nook-green { background-color: #8dd6c3; }
        .bg-cream { background-color: #fbf9ef; }
        .text-brown { color: #5d4037; }

        /* ç¡¬å¹£æ¨£å¼ */
        .money-btn {
            transition: all 0.1s;
            user-select: none;
            border-bottom: 4px solid rgba(0,0,0,0.2);
        }
        .money-btn:active {
            transform: translateY(4px);
            border-bottom: 0px solid transparent;
        }

        .coin-50 { background: #ffd700; border: 2px solid #e6c200; border-bottom: 5px solid #d4b200; color: #8a6d00; }
        .coin-10 { background: #e0e0e0; border: 2px solid #bdbdbd; border-bottom: 5px solid #9e9e9e; color: #616161; }
        .coin-5 { background: #ffab91; border: 2px solid #ff8a65; border-bottom: 5px solid #e64a19; color: #bf360c; }
        .coin-1 { background: #ffe0b2; border: 2px solid #ffcc80; border-bottom: 5px solid #fb8c00; color: #e65100; }

        /* å‹•ç•« */
        .leaf-spin { animation: spin-leaf 3s ease-in-out infinite; }
        @keyframes spin-leaf {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(10deg); }
            75% { transform: rotate(-10deg); }
            100% { transform: rotate(0deg); }
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        .shake { animation: shake 0.4s ease-in-out; }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        .pop { animation: pop 0.2s ease-out; }

        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* æ¨¡æ…‹è¦–çª—æ¨£å¼ */
        .modal-overlay {
            background-color: rgba(93, 64, 55, 0.6);
            backdrop-filter: blur(4px);
        }
        
        /* æ²è»¸ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #8dd6c3; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4db6ac; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-4">

    <!-- èƒŒæ™¯éŸ³æ¨‚ (ä½¿ç”¨ Pixabay çš„è¼•å¿«å…è²»éŸ³æ¨‚) -->
    <!-- ç‚ºäº†é¿å…è·¨åŸŸå•é¡Œï¼Œå»ºè­°ä½¿ç”¨æ¨™æº–éŸ³è¨Šæ ¼å¼ã€‚é€™è£¡ä½¿ç”¨ä¸€å€‹ç©©å®šçš„ CDN ç¯„ä¾‹ -->
    <audio id="bgm" loop>
        <source src="https://cdn.pixabay.com/download/audio/2022/01/26/audio_d0c6ff131d.mp3" type="audio/mpeg">
        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éŸ³æ¨‚æ’­æ”¾ã€‚
    </audio>

    <!-- éŠæˆ²ä¸»å®¹å™¨ -->
    <div class="w-full max-w-md bg-cream rounded-[40px] shadow-[0_10px_30px_rgba(0,0,0,0.1)] overflow-hidden flex flex-col h-full max-h-[850px] border-8 border-white box-border ring-4 ring-[#8dd6c3]/30 relative">
        
        <!-- é ‚éƒ¨è³‡è¨Šåˆ— -->
        <div class="bg-nook-green p-4 flex justify-between items-center text-white relative overflow-hidden z-10 shadow-sm">
            <div class="absolute -top-4 -left-4 w-20 h-20 bg-white/20 rounded-full"></div>
            
            <!-- å·¦å´ï¼šéŸ³æ¨‚é–‹é—œ -->
            <button onclick="toggleSound()" id="soundBtn" class="bg-white/20 px-3 py-1 rounded-full border border-white/30 hover:bg-white/30 transition flex items-center gap-2 z-20">
                <i class="fas fa-music text-white" id="soundIcon"></i>
            </button>

            <!-- æ™‚é–“é¡¯ç¤º -->
            <div class="flex items-center gap-2 bg-white/20 px-3 py-1 rounded-full border border-white/30">
                <i class="fas fa-stopwatch text-white animate-pulse"></i>
                <span id="timerDisplay" class="font-black text-xl w-8 text-center">60</span>
            </div>

            <!-- åˆ†æ•¸é¡¯ç¤º -->
            <div class="bg-white/90 px-3 py-1 rounded-full font-bold text-[#00695c] shadow-sm flex items-center gap-2 z-20">
                <i class="fas fa-coins text-yellow-500"></i>
                <span id="scoreDisplay">0</span>
            </div>
        </div>

        <!-- éŠæˆ²å€åŸŸ -->
        <div class="flex-1 flex flex-col p-6 overflow-y-auto relative bg-cream">
            
            <!-- æç¤ºæ°£æ³¡ -->
            <div class="bg-white rounded-2xl p-3 shadow-sm mb-2 text-center border-2 border-[#8dd6c3] border-dashed">
                <p id="messageDisplay" class="font-bold text-lg text-[#00695c]">
                    æº–å‚™å¥½äº†å—ï¼Ÿ
                </p>
            </div>

            <!-- é¡Œç›®å¡ç‰‡ -->
            <div class="bg-[#fff9c4] p-5 rounded-[30px] shadow-sm rotate-1 mt-2 border-2 border-[#fff59d] fade-in relative transition-all" id="questionCard">
                <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-20 h-5 bg-[#81d4fa]/60 rotate-2"></div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div class="bg-white/60 p-2 rounded-xl border border-[#fff176]">
                        <div class="text-[#f57f17] text-xs font-bold">å•†å“åƒ¹æ ¼</div>
                        <div class="text-xl font-black text-[#f57f17]">$<span id="priceDisplay">0</span></div>
                    </div>
                    <div class="bg-white/60 p-2 rounded-xl border border-[#fff176]">
                        <div class="text-[#0277bd] text-xs font-bold">å®¢äººæ”¯ä»˜</div>
                        <div class="text-xl font-black text-[#0277bd]">$<span id="paidDisplay">0</span></div>
                    </div>
                </div>
                
                <div class="border-t-2 border-dashed border-[#fbc02d]/30 my-2"></div>
                
                <div class="text-center">
                    <div class="text-[#5d4037]/70 font-bold text-xs mb-1">ç¸½å…±è¦æ‰¾</div>
                    <div class="text-4xl font-black text-[#2e7d32] tracking-wider">$<span id="targetDisplay">0</span></div>
                </div>
            </div>

            <!-- æ”¶éŠ€ç›¤å€åŸŸ -->
            <div class="mt-auto mb-2">
                <div class="bg-[#5d4037] text-[#fff8e1] p-3 rounded-t-3xl shadow-inner flex justify-between items-center transition-all border-b-4 border-[#3e2723]" id="currentArea">
                    <div class="text-[#d7ccc8] text-sm font-bold">æ”¶éŠ€ç›¤:</div>
                    <div class="text-2xl font-mono text-[#ffecb3] tracking-wider font-black">$<span id="currentGivenDisplay">0</span></div>
                </div>
                
                <div class="bg-[#6d4c41] rounded-b-3xl p-3 min-h-[70px] shadow-lg flex flex-wrap justify-center gap-2 content-start border-t border-[#8d6e63]">
                     <div id="coinStack" class="flex flex-wrap justify-center gap-1 w-full"></div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨æ§åˆ¶å€ -->
        <div class="bg-white/80 border-t-2 border-[#e0f2f1] p-4 pb-6 backdrop-blur-sm z-10">
            <div class="grid grid-cols-4 gap-2 mb-3">
                <button onclick="addMoney(50)" class="money-btn coin-50 w-full aspect-square rounded-full flex flex-col items-center justify-center shadow-md active:shadow-none">
                    <span class="text-[10px] opacity-80">é‡‘</span>
                    <span class="text-xl font-black">50</span>
                </button>
                <button onclick="addMoney(10)" class="money-btn coin-10 w-full aspect-square rounded-full flex flex-col items-center justify-center shadow-md active:shadow-none">
                    <span class="text-[10px] opacity-80">éŠ€</span>
                    <span class="text-xl font-black">10</span>
                </button>
                <button onclick="addMoney(5)" class="money-btn coin-5 w-full aspect-square rounded-full flex flex-col items-center justify-center shadow-md active:shadow-none">
                    <span class="text-[10px] opacity-80">éŠ…</span>
                    <span class="text-xl font-black">5</span>
                </button>
                <button onclick="addMoney(1)" class="money-btn coin-1 w-full aspect-square rounded-full flex flex-col items-center justify-center shadow-md active:shadow-none">
                    <span class="text-[10px] opacity-80">å°</span>
                    <span class="text-xl font-black">1</span>
                </button>
            </div>
            <button onclick="clearMoney()" class="w-full bg-[#ffcdd2] hover:bg-[#ef9a9a] text-[#c62828] font-bold py-2 rounded-2xl transition border-b-4 border-[#e57373] active:border-b-0 active:translate-y-1 flex items-center justify-center gap-2">
                <i class="fas fa-eraser"></i> ç®—éŒ¯äº†ï¼Œé‡ä¾†ï¼
            </button>
        </div>

        <!-- é–‹å§‹ç•«é¢é®ç½© -->
        <div id="startScreen" class="absolute inset-0 bg-[#b8e9e4] z-50 flex flex-col items-center justify-center p-6 text-center">
            <div class="bg-white p-8 rounded-[40px] shadow-xl border-4 border-white ring-4 ring-[#8dd6c3] max-w-sm w-full transform rotate-1">
                <div class="text-6xl mb-4 animate-bounce">ğŸ¦</div>
                <h2 class="text-3xl font-black text-[#00695c] mb-2">å•†åº—å°å¹«æ‰‹</h2>
                <p class="text-[#5d4037] mb-6 font-bold">é™æ™‚ 60 ç§’ï¼<br>ä¾†æŒ‘æˆ°ä½ çš„æ”¶éŠ€é€Ÿåº¦å§ï¼</p>
                
                <button onclick="startGame()" class="w-full bg-[#ffb74d] hover:bg-[#ffa726] text-white text-xl font-black py-4 rounded-full shadow-lg border-b-4 border-[#f57c00] active:border-b-0 active:translate-y-1 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-play"></i> é–‹å§‹ç‡Ÿæ¥­
                </button>
                
                <button onclick="showLeaderboard()" class="mt-4 text-[#00695c] font-bold underline hover:text-[#004d40]">
                    æŸ¥çœ‹æœ¬é€±æ’è¡Œæ¦œ (æœ¬æ©Ÿ)
                </button>
            </div>
        </div>

        <!-- çµç®—/æ’è¡Œæ¦œ æ¨¡æ…‹è¦–çª— -->
        <div id="resultModal" class="hidden absolute inset-0 modal-overlay z-50 flex flex-col items-center justify-center p-4">
            <div class="bg-[#fbf9ef] w-full max-w-sm rounded-[30px] shadow-2xl overflow-hidden border-4 border-white flex flex-col max-h-[90%]">
                <!-- æ¨™é¡Œ -->
                <div class="bg-[#8dd6c3] p-4 text-center">
                    <h2 class="text-2xl font-black text-white" id="modalTitle">æœ¬é€±æ’è¡Œæ¦œ</h2>
                    <p class="text-white/80 text-xs font-bold mt-1">æ¯é€±ä¸€ 04:00 é‡ç½®</p>
                </div>
                
                <!-- å…§å®¹å€ -->
                <div class="p-6 overflow-y-auto flex-1">
                    <!-- ä½ çš„åˆ†æ•¸ (éŠæˆ²çµæŸæ™‚é¡¯ç¤º) -->
                    <div id="yourScoreSection" class="hidden mb-6 text-center bg-white p-4 rounded-2xl border-2 border-[#fff176] shadow-sm">
                        <div class="text-sm text-gray-500 font-bold">æœ¬æ¬¡å¾—åˆ†</div>
                        <div class="text-5xl font-black text-[#f57f17] my-2" id="finalScoreDisplay">0</div>
                        
                        <!-- è¼¸å…¥åå­— -->
                        <div class="mt-4" id="inputNameSection">
                            <input type="text" id="playerNameInput" placeholder="è«‹è¼¸å…¥æš±ç¨±" maxlength="8" 
                                class="w-full bg-gray-100 border-2 border-gray-300 rounded-xl px-4 py-2 text-center font-bold focus:outline-none focus:border-[#8dd6c3] text-[#5d4037]">
                            <button onclick="submitScore()" id="submitBtn" class="mt-2 w-full bg-[#8dd6c3] text-white font-bold py-2 rounded-xl shadow-sm border-b-4 border-[#4db6ac] active:border-b-0 active:translate-y-1">
                                ç™»è¨˜åˆ†æ•¸
                            </button>
                        </div>
                        <div id="scoreSubmittedMsg" class="hidden text-green-600 font-bold mt-2">
                            <i class="fas fa-check"></i> å·²ç™»è¨˜ï¼
                        </div>
                    </div>

                    <!-- æ’è¡Œæ¦œåˆ—è¡¨ -->
                    <div class="bg-white rounded-2xl border-2 border-[#e0e0e0] overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-[#eeeeee] text-[#757575] text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-2 font-bold text-center w-12">#</th>
                                    <th class="px-4 py-2 font-bold">åº—å“¡</th>
                                    <th class="px-4 py-2 font-bold text-right">åˆ†</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardBody" class="text-sm font-bold text-[#5d4037]">
                                <!-- å‹•æ…‹ç”Ÿæˆ -->
                                <tr><td colspan="3" class="text-center py-4">è¼‰å…¥ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- åº•éƒ¨æŒ‰éˆ• -->
                <div class="p-4 bg-gray-50 border-t border-gray-200 flex gap-2">
                    <button onclick="closeModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-white font-bold py-3 rounded-xl transition">
                        é—œé–‰
                    </button>
                    <button onclick="restartGame()" class="flex-1 bg-[#ffb74d] hover:bg-[#ffa726] text-white font-bold py-3 rounded-xl shadow-sm border-b-4 border-[#f57c00] active:border-b-0 active:translate-y-1 transition" id="restartBtn">
                        å†ç©ä¸€æ¬¡
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- æœ¬æ©Ÿç‰ˆ JS (ä¸ä¾è³´ Firebase) -->
    <script>
        // å…¨åŸŸè®Šæ•¸
        window.startGame = startGame;
        window.addMoney = addMoney;
        window.clearMoney = clearMoney;
        window.showLeaderboard = showLeaderboard;
        window.submitScore = submitScore;
        window.closeModal = closeModal;
        window.restartGame = restartGame;
        window.toggleSound = toggleSound;

        // --- éŸ³æ•ˆç³»çµ± (ä½¿ç”¨ Web Audio APIï¼Œä¸éœ€è¦å¤–éƒ¨æª”æ¡ˆ) ---
        const SoundManager = {
            ctx: null,
            isMuted: false,

            init: function() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
            },

            playTone: function(freq, type, duration, startTime = 0) {
                if (this.isMuted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(this.ctx.currentTime + startTime);
                
                // è²éŸ³æ·¡å‡ºæ•ˆæœ
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime + startTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + startTime + duration);
                osc.stop(this.ctx.currentTime + startTime + duration);
            },

            playCoin: function() {
                this.init();
                // å®ï¼é«˜éŸ³æ­£å¼¦æ³¢
                this.playTone(1200, 'sine', 0.1);
                this.playTone(2000, 'sine', 0.1, 0.05); // é›™é‡éŸ³æ›´æœ‰è³ªæ„Ÿ
            },

            playCorrect: function() {
                this.init();
                // æˆåŠŸå’Œå¼¦ (C -> E -> G -> C)
                this.playTone(523.25, 'sine', 0.2, 0);
                this.playTone(659.25, 'sine', 0.2, 0.1);
                this.playTone(783.99, 'sine', 0.2, 0.2);
                this.playTone(1046.50, 'sine', 0.4, 0.3);
            },

            playWrong: function() {
                this.init();
                // å¤±æ•—ä½éŸ³ (é‹¸é½’æ³¢æ¯”è¼ƒåˆºè€³)
                this.playTone(150, 'sawtooth', 0.3, 0);
                this.playTone(100, 'sawtooth', 0.3, 0.2);
            },

            playClear: function() {
                this.init();
                // æ¸…é™¤è² (æ»‘éŸ³æ•ˆæœæ¨¡æ“¬)
                if (this.isMuted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.frequency.setValueAtTime(400, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, this.ctx.currentTime + 0.2);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.2);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.2);
            },

            playTimeUp: function() {
                this.init();
                this.playTone(800, 'square', 0.1, 0);
                this.playTone(800, 'square', 0.1, 0.2);
                this.playTone(800, 'square', 0.4, 0.4);
            }
        };

        // --- èƒŒæ™¯éŸ³æ¨‚æ§åˆ¶ ---
        const bgm = document.getElementById('bgm');
        bgm.volume = 0.4; // éŸ³é‡å°ä¸€é»

        function toggleSound() {
            SoundManager.isMuted = !SoundManager.isMuted;
            const icon = document.getElementById('soundIcon');
            
            if (SoundManager.isMuted) {
                icon.className = "fas fa-volume-mute text-gray-400";
                bgm.pause();
            } else {
                icon.className = "fas fa-music text-white";
                // åªæœ‰åœ¨éŠæˆ²é€²è¡Œä¸­æ‰æ’­æ”¾éŸ³æ¨‚
                if(gameState.isPlaying) {
                    bgm.play().catch(e => console.log("ç­‰å¾…ä½¿ç”¨è€…äº’å‹•æ‰èƒ½æ’­æ”¾"));
                }
            }
        }

        // --- éŠæˆ²é‚è¼¯ ---
        let gameState = {
            score: 0,
            price: 0,
            paid: 0,
            targetChange: 0,
            currentGiven: 0,
            isProcessing: false,
            isPlaying: false,
            timeLeft: 60,
            timerInterval: null
        };

        const els = {
            score: document.getElementById('scoreDisplay'),
            timer: document.getElementById('timerDisplay'),
            price: document.getElementById('priceDisplay'),
            paid: document.getElementById('paidDisplay'),
            target: document.getElementById('targetDisplay'),
            given: document.getElementById('currentGivenDisplay'),
            message: document.getElementById('messageDisplay'),
            area: document.getElementById('currentArea'),
            stack: document.getElementById('coinStack'),
            startScreen: document.getElementById('startScreen'),
            resultModal: document.getElementById('resultModal'),
            modalTitle: document.getElementById('modalTitle'),
            yourScoreSec: document.getElementById('yourScoreSection'),
            finalScore: document.getElementById('finalScoreDisplay'),
            lbBody: document.getElementById('leaderboardBody'),
            inputSec: document.getElementById('inputNameSection'),
            submitMsg: document.getElementById('scoreSubmittedMsg'),
            nameInput: document.getElementById('playerNameInput'),
            restartBtn: document.getElementById('restartBtn')
        };

        function getWeeklyStorageKey() {
            const now = new Date();
            const adjusted = new Date(now.getTime() - 4 * 60 * 60 * 1000);
            const day = adjusted.getDay();
            const diff = adjusted.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(adjusted.setDate(diff));
            const yyyy = monday.getFullYear();
            const mm = String(monday.getMonth() + 1).padStart(2, '0');
            const dd = String(monday.getDate()).padStart(2, '0');
            return `store_game_scores_${yyyy}_${mm}_${dd}`;
        }

        function startGame() {
            // åˆå§‹åŒ–éŸ³æ•ˆå¼•æ“ (ç€è¦½å™¨éœ€è¦ä½¿ç”¨è€…äº’å‹•å¾Œæ‰èƒ½ç™¼è²)
            SoundManager.init();
            if (!SoundManager.isMuted) {
                bgm.currentTime = 0;
                bgm.play().catch(e => console.log("Autoplay blocked"));
            }

            els.startScreen.classList.add('hidden');
            gameState.score = 0;
            gameState.timeLeft = 60;
            gameState.isPlaying = true;
            gameState.isProcessing = false;
            
            updateUI();
            initQuestion();
            
            if (gameState.timerInterval) clearInterval(gameState.timerInterval);
            gameState.timerInterval = setInterval(() => {
                if (!gameState.isPlaying) return;
                
                gameState.timeLeft--;
                els.timer.textContent = gameState.timeLeft;
                
                if (gameState.timeLeft <= 10) {
                    els.timer.parentElement.classList.add('bg-red-500', 'animate-pulse');
                    els.timer.parentElement.classList.remove('bg-white/20');
                }

                if (gameState.timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function endGame() {
            gameState.isPlaying = false;
            clearInterval(gameState.timerInterval);
            bgm.pause(); // åœæ­¢éŸ³æ¨‚
            SoundManager.playTimeUp(); // æ’­æ”¾æ™‚é–“åˆ°éŸ³æ•ˆ
            
            els.resultModal.classList.remove('hidden');
            els.modalTitle.textContent = "æ™‚é–“åˆ°ï¼";
            els.yourScoreSec.classList.remove('hidden');
            els.finalScore.textContent = gameState.score;
            els.inputSec.classList.remove('hidden');
            els.submitMsg.classList.add('hidden');
            els.restartBtn.textContent = "å†ç©ä¸€æ¬¡";

            loadLeaderboard();
        }

        function restartGame() {
            closeModal();
            startGame();
            els.timer.parentElement.classList.remove('bg-red-500', 'animate-pulse');
            els.timer.parentElement.classList.add('bg-white/20');
        }

        function initQuestion() {
            gameState.price = Math.floor(Math.random() * 80) + 11;
            if (gameState.price <= 50) gameState.paid = 50;
            else gameState.paid = 100;

            gameState.targetChange = gameState.paid - gameState.price;
            gameState.currentGiven = 0;
            gameState.isProcessing = false;

            updateGameDisplay();
            
            els.stack.innerHTML = '';
            els.message.innerHTML = 'è«‹æ‰¾é›¶çµ¦å®¢äººï¼';
            els.message.className = "font-bold text-lg text-[#00695c]";
            els.area.className = "bg-[#5d4037] text-[#fff8e1] p-3 rounded-t-3xl shadow-inner flex justify-between items-center transition-all border-b-4 border-[#3e2723]";
        }

        function updateUI() {
            els.score.textContent = gameState.score;
            els.timer.textContent = gameState.timeLeft;
        }

        function updateGameDisplay() {
            els.price.textContent = gameState.price;
            els.paid.textContent = gameState.paid;
            els.target.textContent = gameState.targetChange;
            els.given.textContent = gameState.currentGiven;
        }

        function addMoney(amount) {
            if (!gameState.isPlaying || gameState.isProcessing) return;

            // æ’­æ”¾é‡‘å¹£éŸ³æ•ˆ
            SoundManager.playCoin();

            gameState.currentGiven += amount;
            
            const coin = document.createElement('div');
            let colorClass = '';
            if (amount === 50) colorClass = 'bg-[#ffd700] text-[#8a6d00] border-[#e6c200]';
            else if (amount === 10) colorClass = 'bg-[#e0e0e0] text-[#616161] border-[#bdbdbd]';
            else if (amount === 5) colorClass = 'bg-[#ffab91] text-[#bf360c] border-[#ff8a65]';
            else colorClass = 'bg-[#ffe0b2] text-[#e65100] border-[#ffcc80]';
            
            const rotate = Math.floor(Math.random() * 30) - 15;
            coin.className = `${colorClass} w-8 h-8 rounded-full border-2 flex items-center justify-center text-[10px] font-black shadow-sm fade-in transform`;
            coin.style.transform = `rotate(${rotate}deg)`;
            coin.textContent = amount;
            els.stack.appendChild(coin);

            els.area.classList.add('pop');
            setTimeout(() => els.area.classList.remove('pop'), 200);

            updateGameDisplay();
            checkStatus();
        }

        function clearMoney() {
            if (!gameState.isPlaying || gameState.isProcessing) return;
            
            SoundManager.playClear(); // æ’­æ”¾æ¸…é™¤éŸ³æ•ˆ

            gameState.currentGiven = 0;
            els.stack.innerHTML = '';
            els.message.textContent = "å·²æ¸…ç©º";
            els.area.className = "bg-[#5d4037] text-[#fff8e1] p-3 rounded-t-3xl shadow-inner flex justify-between items-center transition-all border-b-4 border-[#3e2723]";
            updateGameDisplay();
        }

        function checkStatus() {
            if (gameState.currentGiven === gameState.targetChange) {
                SoundManager.playCorrect(); // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
                gameState.isProcessing = true;
                gameState.score += 10;
                updateUI();
                
                els.message.innerHTML = 'æ”¶éŠ€æ­£ç¢ºï¼ <i class="fas fa-check"></i>';
                els.message.className = "font-bold text-lg text-[#2e7d32]";
                els.area.className = "bg-[#2e7d32] text-white p-3 rounded-t-3xl shadow-inner flex justify-between items-center transition-all border-b-4 border-[#1b5e20] pop";

                setTimeout(initQuestion, 1000);

            } else if (gameState.currentGiven > gameState.targetChange) {
                SoundManager.playWrong(); // æ’­æ”¾å¤±æ•—éŸ³æ•ˆ
                els.message.innerHTML = 'æ‰¾å¤ªå¤šäº†ï¼ <i class="fas fa-times"></i>';
                els.message.className = "font-bold text-lg text-[#c62828]";
                els.area.className = "bg-[#c62828] text-white p-3 rounded-t-3xl shadow-inner flex justify-between items-center transition-all border-b-4 border-[#b71c1c] shake";
                
                setTimeout(() => {
                    clearMoney();
                    SoundManager.playClear();
                }, 1000);
            }
        }

        function showLeaderboard() {
            els.resultModal.classList.remove('hidden');
            els.modalTitle.textContent = "æœ¬é€±è‹±é›„æ¦œ (æœ¬æ©Ÿ)";
            els.yourScoreSec.classList.add('hidden');
            els.restartBtn.textContent = "é—œé–‰";
            loadLeaderboard();
        }

        function closeModal() {
            els.resultModal.classList.add('hidden');
        }

        function submitScore() {
            const name = els.nameInput.value.trim() || "ç„¡åæ°";
            const score = gameState.score;
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = "å„²å­˜ä¸­...";

            try {
                const key = getWeeklyStorageKey();
                let scores = JSON.parse(localStorage.getItem(key) || "[]");
                scores.push({ name: name, score: score, timestamp: new Date().toISOString() });
                scores.sort((a, b) => b.score - a.score);
                scores = scores.slice(0, 20);
                localStorage.setItem(key, JSON.stringify(scores));

                els.inputSec.classList.add('hidden');
                els.submitMsg.classList.remove('hidden');
                loadLeaderboard();
            } catch (e) {
                console.error(e);
                alert("å„²å­˜å¤±æ•—");
            } finally {
                btn.disabled = false;
                btn.textContent = "ç™»è¨˜åˆ†æ•¸";
            }
        }

        function loadLeaderboard() {
            els.lbBody.innerHTML = '<tr><td colspan="3" class="text-center py-4">è®€å–ä¸­...</td></tr>';
            try {
                const key = getWeeklyStorageKey();
                let scores = JSON.parse(localStorage.getItem(key) || "[]");
                const top10 = scores.slice(0, 10);
                renderLeaderboard(top10);
            } catch (e) {
                console.error(e);
                els.lbBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-500">ç„¡æ³•è®€å–æ’è¡Œæ¦œ</td></tr>';
            }
        }

        function renderLeaderboard(scores) {
            els.lbBody.innerHTML = '';
            if (scores.length === 0) {
                els.lbBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-400">æœ¬é€±é‚„æ²’æœ‰äººæŒ‘æˆ°å–”ï¼</td></tr>';
                return;
            }
            scores.forEach((s, index) => {
                const rank = index + 1;
                let rankClass = "text-gray-500";
                let icon = "";
                if (rank === 1) { rankClass = "text-yellow-500 text-lg"; icon = "ğŸ‘‘ "; }
                else if (rank === 2) { rankClass = "text-gray-400 text-lg"; icon = "ğŸ¥ˆ "; }
                else if (rank === 3) { rankClass = "text-orange-400 text-lg"; icon = "ğŸ¥‰ "; }

                const row = document.createElement('tr');
                row.className = "border-b border-gray-100 hover:bg-gray-50";
                row.innerHTML = `
                    <td class="px-4 py-3 font-black text-center ${rankClass}">${icon}${rank}</td>
                    <td class="px-4 py-3 truncate max-w-[100px]">${escapeHtml(s.name)}</td>
                    <td class="px-4 py-3 font-black text-right text-[#00695c]">${s.score}</td>
                `;
                els.lbBody.appendChild(row);
            });
        }

        function escapeHtml(text) {
            if (!text) return text;
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>